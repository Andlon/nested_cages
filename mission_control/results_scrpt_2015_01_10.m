% Symmetry example 1 - Test 
[V0,F0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/meshes-for-leo/Model7_fixed.off');
% simulation got stuck for the usual levels = floor(2.^((-14:2:-2)/3)*size(F0,1));
levels = floor(2.^((-14:2:-6)/3)*size(F0,1));
[cages_V,cages_F,Pall] = ...
multires_per_layer( ...
V0,F0, ...
levels, ...
'QuadratureOrder',2, ...
'ExpansionEnergy','symmetry_x', ...
'FinalEnergy','none', ...
'BetaInit',1e-1, ...
'Eps',1e-3);
write_cages('../../Meshes/Results/Model7_symmetry/Model7',cages_V,cages_F);
save('../../Meshes/Results/Model7_symmetry/Model7/timing.mat','timing')
% Obs.: OK

% Symmetry result - Swat
[V0,F0] = readPLY('/Users/Leo/PHD_Work/Cage_Generation_2013/models/swat.ply');
[V_cage0,F_cage0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/swat-cage.obj');
[V_cage0,F_cage0] = meshfix_matlab(V_cage0,F_cage0);
V_cage0 = V_cage0-[0.46407*ones(size(V_cage0,1),1) zeros(size(V_cage0,1),1) zeros(size(V_cage0,1),1)];
V0 = V0-[0.46407*ones(size(V0,1),1) zeros(size(V0,1),1) zeros(size(V0,1),1)];
V_coarse{1} = V_cage0;
F_coarse{1} = F_cage0;
[cages_V,cages_F,~,~,~,timing] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',3, ...
'ExpansionEnergy','symmetry_x', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'EpsExpansion',1e-3,...
'EpsFinal',1e-3,...
'V_coarse',V_coarse,'F_coarse',F_coarse,...
'StepSize',5e-3);
save('/Users/Leo/PHD_Work/Cage_Generation_2013/nested_cages/Meshes/Results/swat_symmetry/timing.mat','timing');
% Obs.: OK

% Kenshi's hand
[V0,F0] = readPLY('/Users/Leo/PHD_Work/Cage_Generation_2013/models/hand_base-clean.ply');
V0 = V0/max(max(abs(V0)));
[V_tri,F_tri] = readOFF('/Users/Leo/PHD_Work/Cage_Generation_2013/models/hand_retopo_tri.off');
V_tri = V_tri/max(max(abs(V_tri)));
F_quad = [F_tri(1:end/2,:) F_tri(end/2+1:end,3)];
V_quad_fixed = planarize(V_tri,F_quad);
V_coarse{1} = V_quad_fixed;
F_coarse{1} = F_tri;
% D_CV_MIN = 1e-5 --> Final energy: 1.62651e-10+
% D_CV_MIN = 1e-7 --> Final energy: 1.43139e-12+
[cages_V,cages_F,Pall] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','planarity', ...
'FinalEnergy','none', ...
'BetaInit',1e+4, ...
'Eps',1e-3,...
'Fquad',F_quad,...
'V_coarse',V_coarse,'F_coarse',F_coarse,...
'D_CV_MIN',1e-7);
write_cages('../../Meshes/Results/KenshiHand_planarity/KenshiHand',cages_V,cages_F);

% Kenshi's hand (hole filled and aligned)
[V0,F0] = readPLY('/Users/Leo/PHD_Work/Cage_Generation_2013/models/hand-fixed.ply');
F0 = F0+1;
[V_quad,F_quad] = readPLY('/Users/Leo/PHD_Work/Cage_Generation_2013/models/hand-cage-fixed.ply');
F_quad = F_quad+1;
V_quad = planarize(V_quad,F_quad);
V_coarse{1} = V_quad;
F_coarse{1} = [F_quad(:,[1 2 3]);F_quad(:,[1 3 4])];
% D_CV_MIN = 1e-5 --> energy = 1.62425e-08-
% D_CV_MIN = 1e-7 --> energy = 2.44395e-12-
% Running
[cages_V,cages_F,Pall] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','planarity', ...
'FinalEnergy','none', ...
'BetaInit',1e+3, ...
'Eps',1e-3,...
'Fquad',F_quad,...
'V_coarse',V_coarse,'F_coarse',F_coarse,'D_CV_MIN',1e-7);
write_cages('../../Meshes/Results/KenshiHand_planarity/KenshiHandFilled_planarity',cages_V,cages_F);

% Cat comparison
[V0,F0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/sca09_meshes_cages/cat-reference.off');
% open flipper decimation has a zero volume ear that messes the flow up
[cages_V,cages_F,~,~,~,timing] = ...
multires_per_layer( ...
V0,F0, ...
700, ...
'QuadratureOrder',2, ...
'ExpansionEnergy','surface_arap', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'Eps',1e-3);

% Dane: Openflipper not able to decimate. Statistics says there are 
% geometrically degenerate faces. Meshfix doesn't work. Skipping...

% Dog: All initial meshes introduce difficulties for the flow

% Gallop Horse comparison
[V0,F0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/sca09_meshes_cages/horse-gallop-reference.off');
[V_coarse{1},F_coarse{1}] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/sca09_meshes_cages/horse-gallop-reference-openflipper-624.off');
[cages_V,cages_F,~,~,~,timing] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','surface_arap', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'Eps',1e-3,'V_coarse',V_coarse,'F_coarse',F_coarse);

% Kenshi's hand (hole filled and aligned): planariztion + 1e-3*ARAP
[V0,F0] = readPLY('/Users/Leo/PHD_Work/Cage_Generation_2013/models/hand-fixed.ply');
[V_quad,F_quad] = readPLY('/Users/Leo/PHD_Work/Cage_Generation_2013/models/hand-cage-fixed.ply');
V_quad = planarize(V_quad,F_quad);
V_coarse{1} = V_quad;
F_coarse{1} = [F_quad(:,[1 2 3]);F_quad(:,[1 3 4])];
% Running
[cages_V,cages_F,Pall] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','surface_arap_planarity', ...
'FinalEnergy','none', ...
'BetaInit',1e+3, ...
'Eps',1e-3,...
'Fquad',F_quad,...
'V_coarse',V_coarse,'F_coarse',F_coarse);
write_cages('../../Meshes/Results/KenshiHand_planarity/KenshiHandFilled_ARAP_planarity',cages_V,cages_F);
save('../../Meshes/Results/KenshiHand_planarity/timing.mat','timing');

% Octopus/flow
[V0,F0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/meshes-for-leo/octopus_50k.obj');
[V_coarse{1},F_coarse{1}] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/meshes-for-leo/octopus_fixed-1k-openflipper.obj');
[V_coarse{1},F_coarse{1}] = meshfix_matlab(V_coarse{1},F_coarse{1});
[cages_V,cages_F,Pall] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','surface_arap', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'Eps',1e-3,...
'V_coarse',V_coarse,'F_coarse',F_coarse);
write_cages('/Users/Leo/PHD_Work/Cage_Generation_2013/nested_cages/Meshes/Results/flow_comparison_1/octopus_arap',cages_V,cages_F);
[cages_V,cages_F,Pall] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','displacement_path', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'Eps',1e-3,...
'V_coarse',V_coarse,'F_coarse',F_coarse);
write_cages('/Users/Leo/PHD_Work/Cage_Generation_2013/nested_cages/Meshes/Results/flow_comparison_1/octopus_disppath',cages_V,cages_F);
% Now attempt with cMCF
Pall = cmcf_shrink(V0,F0,'MaxIter',50,'delta',5e-5);
[V_coarse_new,timing] = ...
combined_step_project( ...
Pall,F0,...
V_coarse{1},F_coarse{1}, ...
'RefCage',V_coarse{1}, ...
'ExpansionEnergy','displacement_path', ...
'FinalEnergy','none', ...
'Eps',1e-3, ...
'BetaInit',1e-2, ...
'SkipElTopo',false, ...
'Debug',true,...
'Fquad',[],...
'D_CV_MIN',1e-5);
% OK, the line above makes the point, let's try something more extreme
% though (didn't emphazise better)

% Rampant/flow
[V0,F0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/rampant-100k.off');
[V_coarse{1},F_coarse{1}] = cgal_simplification(V0,F0,5000);
% our sequence
[cages_V,cages_F,Pall] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','displacement_path', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'Eps',1e-3,...
'V_coarse',V_coarse,'F_coarse',F_coarse);
% cmcf sequence
Pall = cmcf_shrink(V0,F0,'MaxIter',100,'delta',1e-4);
[V_coarse_new,timing] = ...
combined_step_project( ...
Pall,F0,...
V_coarse{1},F_coarse{1}, ...
'RefCage',V_coarse{1}, ...
'ExpansionEnergy','displacement_path', ...
'FinalEnergy','none', ...
'Eps',1e-3, ...
'BetaInit',1e-2, ...
'SkipElTopo',false, ...
'Debug',true,...
'Fquad',[],...
'D_CV_MIN',1e-5);

% Energy comparisons: Anchor with volume, ARAP and VARAP
% changes in the code: remove assertion on grad size (line 134 of one_step_project)
% top make volume energy work.

% load input mesh and openflipper 200 faces decimation
[V0,F0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/anchor-11k.off');
volume = 1.1481;
[V_coarse{1},F_coarse{1}] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/anchor-200-openflipper.off');
volume = 1.1412;

% Generate Volume result
[cages_V,cages_F,~,~,~,timing] = ...
multires_per_layer( ...
V0,F0, ...
[0], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','displacement_path', ...
'FinalEnergy','volume', ...
'BetaInit',1e-2, ...
'EpsExpansion',5e-3,...
'EpsFinal',5e-4,...
'PartialPath','partial_01_16.mat',...
'StepSize',5e-2,... % needs bigger flow step to emphasize the point
'V_coarse',V_coarse,'F_coarse',F_coarse);
cages_V_volume = cages_V;
cages_F_volume = cages_F;
[~,vol_volume] = centroid(cages_V_volume{1},cages_F_volume{1});
vol_volume = 1.2101;

% Generate Volumetric ARAP result
[cages_V,cages_F,~,~,~,timing] = ...
multires_per_layer( ...
V0,F0, ...
[0], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','volumetric_arap', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'EpsExpansion',1e-3,...
'EpsFinal',1e-3,...
'PartialPath','partial_01_16.mat',...
'StepSize',5e-2,... % needs bigger flow step to emphasize the point
'V_coarse',V_coarse,'F_coarse',F_coarse);
cages_V_varap = cages_V;
cages_F_varap = cages_F;
[~,vol_varap] = centroid(cages_V_varap{1},cages_F_varap{1})
vol_varap = 1.2672;

% Generate ARAP result
[cages_V,cages_F,~,~,~,timing] = ...
multires_per_layer( ...
V0,F0, ...
[0], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','surface_arap', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'EpsExpansion',1e-3,...
'EpsFinal',1e-3,...
'PartialPath','partial_01_16.mat',...
'StepSize',5e-2,...
'V_coarse',V_coarse,'F_coarse',F_coarse);
cages_V_arap = cages_V;
cages_F_arap = cages_F;
[~,vol_arap] = centroid(cages_V_arap{1},cages_F_arap{1})
vol_arap = 1.3039;

% Save cages
write_cages('../../Meshes/Results/anchor_energies_final/anchor_volume',cages_V_volume,cages_F_volume);
write_cages('../../Meshes/Results/anchor_energies_final/anchor_arap',cages_V_arap,cages_F_arap);
write_cages('../../Meshes/Results/anchor_energies_final/anchor_varap',cages_V_varap,cages_F_varap);
writeOBJ('../../Meshes/Results/anchor_energies_final/anchor_initial.obj',V_coarse{1},F_coarse{1})

% Model3 inside Model4 (attempt)
[V0,F0] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/meshes-for-leo/Model3_fixed.obj');
V0 = V0-ones(size(V0,1),1)*[0.5 0.5 0.5];
[Vc,Fc] = load_mesh('/Users/Leo/PHD_Work/Cage_Generation_2013/models/meshes-for-leo/Model4_fixed.obj');
Vc = Vc-ones(size(Vc,1),1)*[0.5 0.5 0.5];
V_coarse{1} = 0.9*Vc;
[cages_V,cages_F,~,~,~,timing] = ...
multires_per_layer( ...
V0,F0, ...
[true], ...
'QuadratureOrder',2, ...
'ExpansionEnergy','volumetric_arap', ...
'FinalEnergy','none', ...
'BetaInit',1e-2, ...
'EpsFinal',1e-3,...
'EpsExpansion',1e-3,...
'V_coarse',V_coarse,'F_coarse',F_coarse,'Smoothing',3e-2);
% Flowed in with these settings, reversing... Done!
write_cages('../../Meshes/Results/Model3_inside_Model4/Model_3_4',cages_V,cages_F);